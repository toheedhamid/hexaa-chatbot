{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-memory",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -288,
        -32
      ],
      "id": "bf269caf-b1aa-4f2b-b2b5-5f77ed8a08ae",
      "name": "Webhook",
      "webhookId": "5bedf5bb-440f-4372-bc75-203eeb22cc5c"
    },
    {
      "parameters": {
        "mode": "expression",
        "numberOutputs": 3,
        "output": "={{ \n  $json.action === \"chat\" ? 0 :\n  $json.action === \"get\" ? 1 :\n  $json.action === \"clear\" ? 2 : 3\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        160,
        -48
      ],
      "id": "a501365c-5ff5-420a-a08f-c302a3242a9f",
      "name": "Switch",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $json.redisKey }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        384,
        -224
      ],
      "id": "7a5d27ac-d0a1-4b3d-8b56-9a7415c55446",
      "name": "Redis GET (Chat)",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "yXsSNEwc8Lpizqg5",
          "name": "Redis account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Get the conversation data that was passed through\nconst conversationData = $('Code in JavaScript').first().json;\n\n// Get Redis data - FIXED: Handle the actual structure\nlet existingHistory = [];\ntry {\n  const redisResult = $input.first().json;\n  console.log('Redis GET result:', JSON.stringify(redisResult));\n  \n  if (redisResult && Object.keys(redisResult).length > 0) {\n    const firstKey = Object.keys(redisResult)[0];\n    if (redisResult[firstKey]) {\n      existingHistory = JSON.parse(redisResult[firstKey]);\n      console.log(`Successfully parsed ${existingHistory.length} messages from Redis`);\n    }\n  }\n} catch (error) {\n  console.error('Error parsing Redis data:', error.message);\n  existingHistory = [];\n}\n\n// Count previous user messages\nconst previousUserMessages = existingHistory.filter(msg => msg.role === 'user').length;\n\n// Add new user message to history\nconst newUserMessage = {\n  role: 'user',\n  content: conversationData.userMessage,\n  timestamp: conversationData.timestamp\n};\n\nconst newHistory = [...existingHistory, newUserMessage];\n\n// Generate bot response\nconst botResponse = {\n  role: 'assistant',\n  content: `I received: \"${conversationData.userMessage}\". This is message #${previousUserMessages + 1} in our conversation.`,\n  timestamp: new Date().toISOString()\n};\n\nnewHistory.push(botResponse);\n\n// Keep only last 20 messages (10 conversation turns)\nlet finalHistory = newHistory;\nif (newHistory.length > 20) {\n  console.log(`Trimming history from ${newHistory.length} to 20 messages`);\n  finalHistory = newHistory.slice(-20);\n}\n\nreturn {\n  conversationId: conversationData.conversationId,\n  redisKey: conversationData.redisKey,\n  chatHistory: finalHistory,\n  latestResponse: botResponse.content,\n  historyCount: previousUserMessages + 1\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        -224
      ],
      "id": "55ed8cb9-8de9-417b-8404-ca3d816f38bb",
      "name": "Process Chat Message"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst historyToSave = data.chatHistory || [];\n\n// Log before saving\nconsole.log('Preparing to save to Redis:', {\n    key: data.redisKey,\n    historyLength: historyToSave.length,\n    firstMessage: historyToSave.length > 0 ? historyToSave[0] : 'No messages'\n});\n\n// Ensure we have a valid array to store\nif (!Array.isArray(historyToSave)) {\n    console.error('Invalid chat history format, converting to array');\n    historyToSave = [];\n}\n\nreturn {\n    conversationId: data.conversationId,\n    redisKey: data.redisKey,\n    chatHistoryString: JSON.stringify(historyToSave),\n    latestResponse: data.latestResponse,\n    historyCount: data.historyCount\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        -224
      ],
      "id": "0b2aab86-3883-4680-b57f-2f80adf57880",
      "name": "Prepare Redis Save"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.redisKey }}",
        "value": "={{ $json.chatHistoryString }}",
        "expire": true,
        "ttl": 86400
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1056,
        -224
      ],
      "id": "149b8fbd-915d-4875-ac6a-0eeeae397c0f",
      "name": "Redis SET (Chat)",
      "credentials": {
        "redis": {
          "id": "yXsSNEwc8Lpizqg5",
          "name": "Redis account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{\n  JSON.stringify({\n    conversationId: $json.conversationId,\n    message: $json.latestResponse,\n    historyCount: $json.historyCount,\n    status: 'success',\n    timestamp: $now.toISO()\n  })\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        1280,
        -224
      ],
      "id": "91fcaf73-0e3f-4cfd-9fca-5a0e90001250",
      "name": "Respond to Webhook (Chat)"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $json.redisKey }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        384,
        -32
      ],
      "id": "f1b9697c-e9a8-49c0-ae70-1c94415517f1",
      "name": "Redis GET (Get History)",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "yXsSNEwc8Lpizqg5",
          "name": "Redis account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const conversationData = $('Code in JavaScript').first().json;\nlet history = [];\nlet message = 'No history found';\n\ntry {\n    const redisResult = $input.first().json;\n    console.log('GET action - Redis result:', JSON.stringify(redisResult));\n    \n    if (redisResult && Object.keys(redisResult).length > 0) {\n        const firstKey = Object.keys(redisResult)[0];\n        if (redisResult[firstKey]) {\n            history = JSON.parse(redisResult[firstKey]);\n            const userMessages = history.filter(msg => msg.role === 'user').length;\n            message = `Retrieved ${userMessages} conversation turns`;\n            console.log(`Found ${history.length} messages in history`);\n        }\n    }\n} catch (error) {\n    message = `Error retrieving history: ${error.message}`;\n    console.error('Error in GET action:', error);\n}\n\nreturn {\n    conversationId: conversationData.conversationId,\n    action: 'get',\n    message: message,\n    history: history,\n    historyCount: history.filter(msg => msg.role === 'user').length,\n    timestamp: new Date().toISOString()\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        -32
      ],
      "id": "4ac3dc61-3602-4880-a843-75a3578da21f",
      "name": "Process Get History"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{\n  JSON.stringify({\n    conversationId: $json.conversationId,\n    action: $json.action,\n    message: $json.message,\n    historyCount: $json.historyCount,\n    history: $json.history,\n    status: 'success',\n    timestamp: $now.toISO()\n  })\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        832,
        -32
      ],
      "id": "435be7a9-55f7-40eb-8047-b4bf30ca93df",
      "name": "Respond to Webhook (Get)"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $json.redisKey }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        384,
        160
      ],
      "id": "9a300fbb-54bc-4b7b-ba88-da87c4ebc7cb",
      "name": "Redis DELETE (Clear)",
      "credentials": {
        "redis": {
          "id": "yXsSNEwc8Lpizqg5",
          "name": "Redis account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{\n  JSON.stringify({\n    conversationId: $json.conversationId,\n    action: $json.action,\n    message: \"Chat history cleared successfully\",\n    status: \"success\",\n    timestamp: $now.toISO()\n  })\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        608,
        160
      ],
      "id": "416f6e55-77ca-4c86-b1e3-6660c5e72356",
      "name": "Respond to Webhook (Clear)"
    },
    {
      "parameters": {
        "jsCode": "const body = items[0].json.body || {};\nconst conversationId = body.conversationId || `conv_${Date.now()}`;\nconst userMessage = body.message || '';\nconst action = body.action || 'chat';\n\n// Enhanced validation\nif (action === 'chat' && !userMessage) {\n    throw new Error('Message is required for chat action');\n}\n\n// Only include userMessage for chat actions\nconst effectiveMessage = (action === 'chat') ? userMessage : '';\n\n// Log the incoming request for debugging\nconsole.log('Incoming request:', {\n    conversationId,\n    action,\n    hasMessage: !!userMessage,\n    timestamp: new Date().toISOString()\n});\n\nreturn [{\n    json: {\n        conversationId: conversationId,\n        userMessage: effectiveMessage,\n        action: action,\n        timestamp: new Date().toISOString(),\n        redisKey: `chat:${conversationId}`,\n        isChatAction: (action === 'chat')\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        -32
      ],
      "id": "e5152016-9316-4487-acd7-202996bf2642",
      "name": "Process Request"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Process Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Request": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis GET (Chat)": {
      "main": [
        [
          {
            "node": "Process Chat Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Chat Message": {
      "main": [
        [
          {
            "node": "Prepare Redis Save",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Redis Save": {
      "main": [
        [
          {
            "node": "Redis SET (Chat)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis SET (Chat)": {
      "main": [
        [
          {
            "node": "Respond to Webhook (Chat)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Redis GET (Chat)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Redis GET (Get History)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Redis DELETE (Clear)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis GET (Get History)": {
      "main": [
        [
          {
            "node": "Process Get History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Get History": {
      "main": [
        [
          {
            "node": "Respond to Webhook (Get)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis DELETE (Clear)": {
      "main": [
        [
          {
            "node": "Respond to Webhook (Clear)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [],
  "pinData": {}
}
